{% include 'header/header.html' %}
{% load staticfiles %}

<h1 class="font-color">
    肺结节检测
</h1>

<button onclick="loaddata()"> load data</button>
<button onmouseleave="changeImg(0)"> refresh </button>

<form id="upload-form" action="/upload/" method="post" enctype="multipart/form-data"">
     {% csrf_token %}
　　　<input type="file" id="upload" name="upload" /> <br />
　　　<input type="submit" value="upload"/>
</form>

<div class="home">
    <div class="div-inline left">
{#        TODO#}
{#        步骤信息#}
        <select id="mhd" onclick="selectMhd()">
            <option value ="1.3.6.1.4.1.14519.5.2.1.6279.6001.100225287222365663678666836860.mhd">test example</option>
            <option value ="fuck.mhd">test2</option>
        </select>
        <table class="table" style="text-align: center;">

            <thead>
                <tr>
                    <th class="table-head">编号</th>
                    <th class="table-head">z  </th>
                    <th class="table-head">y  </th>
                    <th class="table-head">x  </th>
                </tr>
            </thead>

            <tbody id="tb">

                {% for foo in nodules %}

                <tr class="default-cursor" onclick="getNodulesImage(this)" onmouseover="changeColor(this)" onmouseleave="resetColor(this)">
                    <td>{{ foo.id }}</td>
                    <td>{{ foo.z }} </td>
                    <td>{{ foo.y }} </td>
                    <td>{{ foo.x }} </td>
                </tr>

                {% endfor %}

            </tbody>

        </table>
    </div>

    <div class="div-inline middle">
{#        TODO#}
{#        路径#}
        <div class="img-block">
            <div style="text-align: center">
                <img id="ct-img" class="img" onmousemove="getCoordinates()" src="" alt="">
            </div>

            <span class="img-info-top" id="slice"></span>
            <span class="img-info-bot-x" id="mouse-x"></span>
            <span class="img-info-bot-y" id="mouse-y"></span>
        </div>
    </div>

    <div class="div-inline right">
        hello
{#        TODO#}

        <p class="font-color" id="test"> hello </p>
    </div>

</div>

<script language="JavaScript" type="text/javascript">
    var mouseWheel = document.getElementById('ct-img');
    var num = 0;
    var numMax = 100;

    if (mouseWheel.addEventListener) {

        mouseWheel.addEventListener('DOMMouseScroll', function(event) {
            event.target.innerHTML = event.detail;
            event.stopPropagation();
            event.preventDefault();

        }, false);
    }
    mouseWheel.onmousewheel = function(event) {

        event = event || window.event;
        mouseWheel.innerHTML = event.wheelDelta.toString();
        event.returnValue = false;


        // 滚轮，滑动
        if(event.wheelDelta > 0) {
            changeImg(num + 1);
        }else if(event.wheelDelta < 0) {
            changeImg(num - 1);
        }
    }
</script>

<script>
    window.onload = init;

    function init() {
        changeImg(0);
    }

    function getCoordinates() {
        var xinfo = document.getElementById('mouse-x');
        var yinfo = document.getElementById('mouse-y');

        var x = event.clientX - document.getElementById('ct-img').getBoundingClientRect().left;
        var y = event.clientY - document.getElementById('ct-img').getBoundingClientRect().top;

        xinfo.innerHTML = "x: " + Math.round(x);
        yinfo.innerHTML = "y: " + Math.round(y);
    }

    function changeImg(cnt){
        var img = document.getElementById("ct-img");

        var xmlhttp;
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp=new XMLHttpRequest();
        }
        else {// code for IE6, IE5
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }

        xmlhttp.onreadystatechange = function() {
            if(xmlhttp.readyState==4 && xmlhttp.status==200) {

                var jsontext = xmlhttp.response;
                var path = JSON.parse(jsontext)['path'];

                if(typeof(path) != "undefined") {
                    path = "{% static "" %}" + path;
                    img.src = path;
                    document.getElementById('slice').innerHTML = "se: " + cnt;
                    num = parseInt(cnt);
                }
            }
        };
        // TODO
        // 请求图片路径
        xmlhttp.open("GET", "/ajax_dict?cnt=" + cnt + "&value=" + document.getElementById('mhd').value, true);
        xmlhttp.send();
    }

    function getNodulesImage(obj) {
        var img = document.getElementById("ct-img");
        var cnt = obj.cells[1].innerHTML; //结节图片编号

        changeImg(cnt);
    }

    function changeColor(obj) {
        obj.style.color = "gray";
    }

    function resetColor(obj) {
        obj.style.color = "white";
    }

    function loaddata() {
        var xmlhttp;
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp=new XMLHttpRequest();
        }
        else {// code for IE6, IE5
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }

        xmlhttp.onreadystatechange = function() {
            if(xmlhttp.readyState==4 && xmlhttp.status==200) {
            }
        };

        // 请求生成图片
        // 这里把mhd文件名传进去，加载指定的mhd文件
        xmlhttp.open("GET", "/load_img", true);
        xmlhttp.send();

        changeImg(0);

        // TODO
        // 请求生成结节信息
        loadnodules();
    }

    function loadnodules() {
        var xmlhttp;
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp=new XMLHttpRequest();
        }
        else {// code for IE6, IE5
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }

        xmlhttp.onreadystatechange = function() {
            if(xmlhttp.readyState==4 && xmlhttp.status==200) {
                document.getElementById('tb').innerHTML = "";
                addNodulesList('1', '10', '1', '1');
                addNodulesList('1', '20', '1', '1');
                addNodulesList('1', '30', '1', '1');
            }
        };
        // TODO
        // 请求图片路径
        xmlhttp.open("GET", "/load_nodules", true);
        xmlhttp.send();
    }

    function addNodulesList(nid, x, y, z) {
        var item = document.createElement('tr');

        var id = document.createElement('td');
        id.innerHTML = nid;

        var cox = document.createElement('td');
        cox.innerHTML = x;

        var coy = document.createElement('td');
        coy.innerHTML = y;

        var coz = document.createElement('td');
        coz.innerHTML = z;

        item.appendChild(id);
        item.appendChild(cox);
        item.appendChild(coy);
        item.appendChild(coz);

        item.className = 'default-cursor';
        item.setAttribute('onclick', 'getNodulesImage(this)');
        item.setAttribute('onmouseover', 'changeColor(this)');
        item.setAttribute('onmouseleave', 'resetColor(this)');

        document.getElementById('tb').appendChild(item);
    }

    function selectMhd() {
        alert(document.getElementById('mhd').value);
    }

    function loadMhd() {
        alert("fuck u");
    }
</script>

{% include 'footer/footer.html' %}
